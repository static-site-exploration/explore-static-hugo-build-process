# pull the latest content

# build using the prepared implimentation image

# push to distribution repo

# deploy (if needed)


#
# Google Cloud Builder CI configuration
#

steps:

# GET THE CONTENT REPO CREDENTIALS and SETUP FROM THE BUILDER IMAGE


# SETUP WORKSPACE DIRECTORIES

- name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    mkdir -p /workspace/content
    mkdir -p /workspace/build


# PULL CONTENT FROM CONTENT REPO (Use https for now, no keys needed)

- name: 'gcr.io/cloud-builders/git'
  args:
  - '-C'
  - '/workspace/content'
  - 'clone'
  - '$_CONTENT_GIT_REPO_HTTP_LOCATION'
  - '/repo'


# SET LAST COMMIT VARIABLE

- name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
  - eval local_CONTENT_GIT_COMMIT_SHA=$(git -C /workspace/content/repo rev-parse HEAD)"
  - git -C /workspace/content/repo rev-parse HEAD | cat > workspace/data/CONTENT_GIT_COMMIT_SHA.txt


# BUILD SITE PACKAGE

- name: '$_SITE_BUILD_CONTAINER'
  args:
  # feed in arguments i) build location path, ii) content path iii) repo base folder
  - '/workspace/build'
  - '/workspace/content/repo'
  - '/content'


# SETUP KEYS FOR GIT PUSH TO DIST REPO

# Copy the encrypted file from GCS
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['cp', '$_DIST_GIT_SSH_KEY_GCS_URL', '/workspace/tmp/encrypted_key/id_rsa_build.enc']
  volumes:
  - name: 'ssh'
    path: '/root/.ssh'
    
# Decrypt files in the persisted volume
- name: 'gcr.io/cloud-builders/gcloud'
  args:
  - kms
  - decrypt
  - --ciphertext-file=/workspace/tmp/encrypted_key/id_rsa_build.enc
  - --plaintext-file=/root/.ssh/id_rsa_build
  - --location=global
  - --keyring=$_DIST_GIT_SSH_KEY_KMS_KEYRING
  - --key=$_DIST_GIT_SSH_KEY_KMS_KEY
  volumes:
  - name: 'ssh'
    path: '/root/.ssh'
